apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: observability
data:
  config.yaml: |
    # =============================================================================
    # OpenTelemetry Collector Configuration
    # =============================================================================
    
    receivers:
      # OTLP receiver for traces and metrics from applications
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      
      # Prometheus receiver for scraping metrics
      prometheus:
        config:
          scrape_configs:
            - job_name: 'otel-collector'
              scrape_interval: 30s
              static_configs:
                - targets: ['localhost:8888']
      
      # Host metrics for node-level monitoring
      hostmetrics:
        collection_interval: 30s
        scrapers:
          cpu:
          disk:
          filesystem:
          load:
          memory:
          network:
          process:
            include:
              match_type: regexp
              names: ['.*']
    
    processors:
      # Batch processor for efficient export
      batch:
        timeout: 5s
        send_batch_size: 1024
        send_batch_max_size: 2048
      
      # Memory limiter to prevent OOM
      memory_limiter:
        check_interval: 1s
        limit_mib: 256
        spike_limit_mib: 64
      
      # Resource processor to add cluster metadata
      resource:
        attributes:
          - key: cluster.name
            value: rpi-k8s-cluster
            action: upsert
          - key: deployment.environment
            value: development
            action: upsert
      
      # Attributes processor for trace enrichment
      attributes:
        actions:
          - key: service.namespace
            from_attribute: k8s.namespace.name
            action: upsert
    
    exporters:
      # Jaeger exporter for traces
      otlp/jaeger:
        endpoint: jaeger-collector.observability.svc.cluster.local:4317
        tls:
          insecure: true
      
      # Prometheus exporter for metrics
      prometheus:
        endpoint: 0.0.0.0:8889
        namespace: otel
        send_timestamps: true
      
      # VictoriaMetrics remote_write for long-term metrics storage
      prometheusremotewrite/victoriametrics:
        endpoint: http://victoriametrics.observability:8428/api/v1/write
        external_labels:
          cluster: rpi-k8s-cluster
      
      # Loki exporter for logs
      loki:
        endpoint: http://loki.observability:3100/loki/api/v1/push
        labels:
          resource:
            cluster.name: "rpi-k8s-cluster"
            deployment.environment: "development"
          attributes:
            k8s.namespace.name: "k8s.namespace.name"
            k8s.pod.name: "k8s.pod.name"
            k8s.container.name: "k8s.container.name"
      
      # Debug logging (reduce in production)
      logging:
        verbosity: normal
        sampling_initial: 5
        sampling_thereafter: 200
    
    extensions:
      # Health check endpoint
      health_check:
        endpoint: 0.0.0.0:13133
      
      # Performance profiling (disable in production)
      pprof:
        endpoint: 0.0.0.0:1777
      
      # zPages for debugging
      zpages:
        endpoint: 0.0.0.0:55679
    
    service:
      extensions: [health_check, pprof, zpages]
      
      pipelines:
        # Traces pipeline
        traces:
          receivers: [otlp]
          processors: [memory_limiter, resource, attributes, batch]
          exporters: [otlp/jaeger, logging]
        
        # Metrics pipeline - export to both Prometheus and VictoriaMetrics
        metrics:
          receivers: [otlp, prometheus, hostmetrics]
          processors: [memory_limiter, resource, batch]
          exporters: [prometheus, prometheusremotewrite/victoriametrics, logging]
        
        # Logs pipeline - export to Loki
        logs:
          receivers: [otlp]
          processors: [memory_limiter, resource, attributes, batch]
          exporters: [loki, logging]
      
      telemetry:
        logs:
          level: info
        metrics:
          address: 0.0.0.0:8888
