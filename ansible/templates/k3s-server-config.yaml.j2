# =============================================================================
# k3s Server Configuration
# =============================================================================
# Generated by Ansible for {{ inventory_hostname }}
# =============================================================================

# Disable components we'll replace
disable:
  - traefik
  - local-storage

# Networking
flannel-backend: vxlan
cluster-cidr: {{ pod_cidr | default('10.42.0.0/16') }}
service-cidr: {{ service_cidr | default('10.43.0.0/16') }}

# TLS SANs for API server
tls-san:
  - {{ node_ip }}
  - {{ inventory_hostname }}
  - {{ inventory_hostname }}.{{ cluster_domain | default('local') }}
  - localhost
  - 127.0.0.1
{% if additional_sans is defined %}
{% for san in additional_sans %}
  - {{ san }}
{% endfor %}
{% endif %}

# Write kubeconfig with readable permissions
write-kubeconfig-mode: "0644"

# Node configuration
node-label:
  - "node.kubernetes.io/role=control-plane"
  - "hardware/type=desktop"
{% if gpu_enabled | default(false) %}
  - "hardware/gpu=true"
  - "nvidia.com/gpu=true"
{% endif %}

{% if k3s_server_extra_args is defined %}
# Additional server arguments
{% for arg in k3s_server_extra_args %}
{{ arg | regex_replace('^--', '') | regex_replace('=', ': ') }}
{% endfor %}
{% endif %}

# Kubelet configuration
kubelet-arg:
  - "max-pods=110"
  - "system-reserved=cpu=500m,memory=1Gi"
  - "kube-reserved=cpu=500m,memory=512Mi"

# etcd configuration (for HA readiness)
# etcd-expose-metrics: true
