---
# =============================================================================
# External Storage Setup Playbook
# =============================================================================
# Configures external USB SSDs on worker nodes.
#
# Usage:
#   ansible-playbook -i inventory/cluster.yml playbooks/storage-setup.yml
#
# Variables (set in inventory):
#   external_storage_device: /dev/sda (the USB SSD device)
#   external_storage_mount: /mnt/storage (mount point)
# =============================================================================

- name: Setup External Storage on Workers
  hosts: workers
  become: true
  gather_facts: true

  vars:
    storage_device: "{{ external_storage_device | default('auto') }}"
    storage_mount: "{{ external_storage_mount | default('/mnt/storage') }}"
    storage_fs: ext4
    storage_helper_path: /usr/local/sbin/mount-external-storage

  tasks:
    - name: Install storage helper script
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../bootstrap/scripts/mount-external-storage.sh"
        dest: "{{ storage_helper_path }}"
        mode: '0755'

    - name: Configure storage auto-check systemd unit
      ansible.builtin.copy:
        dest: /etc/systemd/system/mount-external-storage.service
        mode: '0644'
        content: |
          [Unit]
          Description=Mount external storage for k3s
          After=network-online.target local-fs.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          ExecStart={{ storage_helper_path }} --check --mount {{ storage_mount }} {% if storage_device == 'auto' or storage_device | length == 0 %}--auto{% else %}--device {{ storage_device }}{% endif %}
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable storage auto-check
      ansible.builtin.systemd:
        name: mount-external-storage
        enabled: true
        state: started
      failed_when: false

    - name: Setup external storage via helper
      ansible.builtin.command: >
        {{ storage_helper_path }}
        --mount {{ storage_mount }}
        --format
        {% if storage_device == 'auto' or storage_device | length == 0 %} --auto {% else %} --device {{ storage_device }} {% endif %}
      register: storage_helper_output
      changed_when: "'Mounted' in storage_helper_output.stdout"
      failed_when: false

    - name: Check if storage is mounted
      ansible.builtin.command: mountpoint -q {{ storage_mount }}
      register: storage_mount_status
      changed_when: false
      failed_when: false

    - name: Create storage subdirectories
      ansible.builtin.file:
        path: "{{ storage_mount }}/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - containers
        - volumes
        - logs
        - k3s
      when: storage_mount_status.rc == 0

    - name: Configure k3s to use external storage
      ansible.builtin.lineinfile:
        path: /etc/rancher/k3s/config.yaml
        line: "data-dir: {{ storage_mount }}/k3s"
        create: true
        mode: '0644'
      notify: Restart k3s-agent
      when: storage_mount_status.rc == 0

    - name: Display storage info
      ansible.builtin.command: df -h {{ storage_mount }}
      register: storage_info
      changed_when: false
      when: storage_mount_status.rc == 0

    - name: Show storage configuration
      ansible.builtin.debug:
        msg: |
          Storage configured on {{ inventory_hostname }}:
          Device: {{ storage_device }}
          Mount: {{ storage_mount }}
          {{ storage_info.stdout if storage_mount_status.rc == 0 else 'Not mounted' }}

  handlers:
    - name: Restart k3s-agent
      ansible.builtin.systemd:
        name: k3s-agent
        state: restarted
      failed_when: false

# =============================================================================
# Setup Local Path Provisioner
# =============================================================================

- name: Install Local Path Provisioner
  hosts: control_plane
  become: true
  gather_facts: false

  tasks:
    - name: Create local-path-provisioner namespace
      ansible.builtin.command: kubectl create namespace local-path-storage --dry-run=client -o yaml | kubectl apply -f -
      changed_when: true

    - name: Install local-path-provisioner
      ansible.builtin.shell: |
        kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.26/deploy/local-path-storage.yaml
      changed_when: true

    - name: Configure local-path-provisioner for external storage
      ansible.builtin.shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: local-path-config
          namespace: local-path-storage
        data:
          config.json: |-
            {
              "nodePathMap": [
                {
                  "node": "DEFAULT_PATH_FOR_NON_LISTED_NODES",
                  "paths": ["/mnt/storage/volumes"]
                }
              ]
            }
        EOF
      changed_when: true

    - name: Set local-path as default storage class
      ansible.builtin.shell: |
        kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
      changed_when: true
      failed_when: false

    - name: Verify storage class
      ansible.builtin.command: kubectl get storageclass
      register: sc_output
      changed_when: false

    - name: Display storage classes
      ansible.builtin.debug:
        msg: "{{ sc_output.stdout_lines }}"
